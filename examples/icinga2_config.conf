/**
 * Icinga2 configuration examples for check_http_data.pl with case sensitivity features
 * 
 * Place this in your Icinga2 configuration directory (typically /etc/icinga2/conf.d/)
 * and customize the host names, endpoints, and check parameters for your environment.
 */

/**
 * Command definition for the check_http_data plugin
 */
object CheckCommand "check_http_data" {
  command = [ PluginDir + "/check_http_data.pl" ]

  arguments = {
    "-H" = {
      value = "$http_data_hostname$"
      description = "Host name or IP address"
    }
    "-p" = {
      value = "$http_data_port$"
      description = "Port number"
    }
    "-u" = {
      value = "$http_data_uri$"
      description = "URI path"
    }
    "-S" = {
      set_if = "$http_data_ssl$"
      description = "Use SSL/HTTPS"
    }
    "-t" = {
      value = "$http_data_timeout$"
      description = "Timeout in seconds"
    }
    "-J" = {
      value = "$http_data_jsonpath$"
      repeat_key = true
      description = "JSONPath expressions"
    }
    "-X" = {
      value = "$http_data_xpath$" 
      repeat_key = true
      description = "XPath expressions"
    }
    "-s" = {
      value = "$http_data_string_checks$"
      repeat_key = true
      description = "String comparison checks"
    }
    "-n" = {
      value = "$http_data_numeric_checks$"
      repeat_key = true
      description = "Numeric range checks"
    }
    "-r" = {
      value = "$http_data_regex_checks$"
      repeat_key = true
      description = "Regular expression checks"
    }
    "-a" = {
      value = "$http_data_auth$"
      description = "HTTP authentication"
    }
    "--header" = {
      value = "$http_data_headers$"
      repeat_key = true
      description = "Additional HTTP headers"
    }
    "--perfdata" = {
      set_if = "$http_data_perfdata$"
      description = "Output performance data"
    }
  }
}

/**
 * Example 1: REST API monitoring with case-insensitive status check (default behavior)
 */
object Service "api-status" {
  host_name = "api-server"
  check_command = "check_http_data"
  
  vars.http_data_hostname = "api.mycompany.com"
  vars.http_data_uri = "/v1/status"
  vars.http_data_ssl = true
  vars.http_data_timeout = 30
  vars.http_data_perfdata = true
  
  vars.http_data_jsonpath = [
    "$.status",
    "$.database.connected",
    "$.services.payment.status"
  ]
  
  vars.http_data_string_checks = [
    # Case-insensitive by default - matches "OK", "ok", "Ok", etc.
    "$.status:ok:OK",
    
    # Explicit case-insensitive check for database connection
    "$.database.connected:true:CRITICAL:i",
    
    # Case-sensitive check for payment service (must be exact case)
    "$.services.payment.status:OPERATIONAL:CRITICAL:c"
  ]
  
  check_interval = 2m
  retry_interval = 30s
  max_check_attempts = 3
}

/**
 * Example 2: E-commerce health monitoring with mixed case sensitivity
 */
object Service "ecommerce-health" {
  host_name = "ecommerce-server"  
  check_command = "check_http_data"
  
  vars.http_data_hostname = "shop.example.com"
  vars.http_data_uri = "/health"
  vars.http_data_ssl = true
  vars.http_data_timeout = 15
  
  vars.http_data_jsonpath = [
    "$.services.cart.status",
    "$.services.payment.status", 
    "$.services.inventory.status",
    "$.database.response_time",
    "$.version"
  ]
  
  vars.http_data_string_checks = [
    # Case-insensitive service status checks (flexible)
    "$.services.cart.status:running:WARNING",
    "$.services.payment.status:healthy:CRITICAL", 
    "$.services.inventory.status:up:WARNING",
    
    # Case-sensitive version check (must match exactly)
    "$.version:v2.1.3:WARNING:c"
  ]
  
  vars.http_data_numeric_checks = [
    # Database response time should be under 100ms (OK), warn at 500ms
    "$.database.response_time:0:100:OK:100:500:WARNING"
  ]
  
  check_interval = 1m
  retry_interval = 20s
  max_check_attempts = 3
}

/**
 * Example 3: XML SOAP service monitoring
 */
object Service "soap-service" {
  host_name = "soap-server"
  check_command = "check_http_data"
  
  vars.http_data_hostname = "soap.internal.com"
  vars.http_data_uri = "/WebService/StatusService.asmx"
  vars.http_data_timeout = 20
  
  vars.http_data_headers = [
    "Content-Type: text/xml; charset=utf-8",
    "SOAPAction: \"http://tempuri.org/GetStatus\""
  ]
  
  vars.http_data_xpath = [
    "//soap:Envelope/soap:Body/GetStatusResponse/status/text()",
    "//soap:Envelope/soap:Body/GetStatusResponse/environment/text()"
  ]
  
  vars.http_data_string_checks = [
    # Case-insensitive status check - allows for different casing
    "//soap:Envelope/soap:Body/GetStatusResponse/status/text():operational:CRITICAL",
    
    # Case-sensitive environment check - must be exactly "PRODUCTION"  
    "//soap:Envelope/soap:Body/GetStatusResponse/environment/text():PRODUCTION:WARNING:c"
  ]
  
  check_interval = 5m
  retry_interval = 1m
  max_check_attempts = 2
}

/**
 * Example 4: Microservices discovery service
 */
object Service "service-discovery" {
  host_name = "discovery-server"
  check_command = "check_http_data"
  
  vars.http_data_hostname = "discovery.k8s.local"
  vars.http_data_port = 8500
  vars.http_data_uri = "/v1/health/state/passing"
  
  vars.http_data_jsonpath = [
    "$[0].Status", 
    "$[0].ServiceName",
    "$[1].Status"
  ]
  
  vars.http_data_string_checks = [
    # Flexible status matching (case-insensitive)
    "$[0].Status:passing:OK",
    "$[1].Status:passing:OK", 
    
    # Exact service name matching (case-sensitive)
    "$[0].ServiceName:UserService:WARNING:c"
  ]
  
  check_interval = 30s
  retry_interval = 15s  
  max_check_attempts = 4
}

/**
 * Example 5: Multi-environment configuration using apply rules
 */
apply Service "api-health-" for (env_name => env_config in host.vars.api_environments) {
  check_command = "check_http_data"
  
  vars.http_data_hostname = env_config.hostname
  vars.http_data_uri = env_config.uri
  vars.http_data_ssl = env_config.ssl
  vars.http_data_timeout = 10
  
  vars.http_data_jsonpath = [ "$.status", "$.environment" ]
  
  vars.http_data_string_checks = [
    # Environment status - case insensitive (allows "OK", "ok", "Ok")
    "$.status:ok:CRITICAL",
    
    # Environment name - case sensitive (must match exactly)
    "$.environment:" + env_config.expected_env + ":WARNING:c" 
  ]
  
  assign where host.vars.api_environments
}

/**
 * Host definition example for the apply rule above
 */
object Host "multi-env-api" {
  address = "api.company.com"
  check_command = "hostalive"
  
  vars.api_environments = {
    "prod" = {
      hostname = "api-prod.company.com"
      uri = "/health"
      ssl = true
      expected_env = "production"
    }
    "staging" = {
      hostname = "api-staging.company.com"  
      uri = "/health"
      ssl = true
      expected_env = "staging"
    }
    "dev" = {
      hostname = "api-dev.company.com"
      uri = "/health" 
      ssl = false
      expected_env = "development"
    }
  }
}

/**
 * Example notification configuration
 */
object Notification "http-data-email" {
  command = "mail-service-notification"
  
  users = [ "admin", "devops" ]
  types = [ Problem, Recovery ]
  states = [ Warning, Critical, Unknown ]
  
  period = "24x7"
  
  assign where service.check_command == "check_http_data"
}